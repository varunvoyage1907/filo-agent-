<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ FILO Dashboard - AI Marketing Agent</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .header h1 { color: #4a5568; font-size: 2.5em; margin-bottom: 10px; }
        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        .status-running { background: #48bb78; color: white; }
        .status-stopped { background: #f56565; color: white; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary { background: #4299e1; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .card h3 { color: #4a5568; margin-bottom: 15px; font-size: 1.3em; }
        .metric { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid #e2e8f0;
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #718096; }
        .metric-value { font-weight: 600; color: #2d3748; }
        .chart-container { 
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .actions-list { max-height: 400px; overflow-y: auto; }
        .action-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        .action-success { background: #f0fff4; border-color: #48bb78; }
        .action-failed { background: #fff5f5; border-color: #f56565; }
        .action-time { font-size: 0.8em; color: #718096; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        @media (max-width: 768px) {
            .status-bar { flex-direction: column; align-items: stretch; }
            .controls { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ FILO Dashboard</h1>
            <p>Facebook Intelligence & Learning Optimizer - Your AI Marketing Agent</p>
            <div class="status-bar">
                <div id="status-indicator" class="status-indicator status-stopped">
                    <span>üî¥</span>
                    <span>Agent Stopped</span>
                </div>
                <div class="controls">
                    <button id="start-btn" class="btn btn-primary" onclick="startFilo()">‚ñ∂Ô∏è Start Filo</button>
                    <button id="stop-btn" class="btn btn-warning" onclick="stopFilo()" disabled>‚è∏Ô∏è Stop Filo</button>
                    <button id="emergency-btn" class="btn btn-danger" onclick="emergencyPause()">üö® Emergency Pause</button>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìä Campaign Overview</h3>
                <div id="overview-metrics">
                    <div class="loading">Loading metrics...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üéØ Ad Set Performance</h3>
                <div id="adset-metrics">
                    <div class="loading">Loading ad sets...</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìà Performance Trends</h3>
            <div id="performance-chart" style="height: 400px;"></div>
        </div>

        <div class="card">
            <h3>‚ö° Recent Actions</h3>
            <div id="recent-actions" class="actions-list">
                <div class="loading">Loading actions...</div>
            </div>
        </div>

        <div class="card">
            <h3>üí¨ Chat with Claude AI</h3>
            <div id="chat-container">
                <div id="chat-messages" style="height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8fafc;">
                    <div class="chat-message filo-message">
                        <strong>ü§ñ Claude:</strong> Hi! I'm Claude, your AI Marketing Expert. I can help you with strategy, optimization, creative development, and real-time campaign management!<br>
                        <small style="color: #718096;">Ask me anything - I'm here to grow your eyewear business!</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Ask Claude anything about your campaigns..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <button onclick="sendMessage()" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;

        // Start Filo
        async function startFilo() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Filo started successfully!');
                    updateDashboard();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error starting Filo: ' + error.message);
            }
        }

        // Stop Filo
        async function stopFilo() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚è∏Ô∏è Filo stopped successfully!');
                    updateDashboard();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error stopping Filo: ' + error.message);
            }
        }

        // Emergency pause
        async function emergencyPause() {
            if (!confirm('üö® Are you sure you want to EMERGENCY PAUSE all campaigns?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/emergency_pause', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('üö® ' + data.message);
                    updateDashboard();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Update dashboard
        async function updateDashboard() {
            await Promise.all([
                updateStatus(),
                updateMetrics(),
                updateActions(),
                updateChart()
            ]);
        }

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const indicator = document.getElementById('status-indicator');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');
                
                if (data.running) {
                    indicator.className = 'status-indicator status-running';
                    indicator.innerHTML = '<span>üü¢</span><span>Agent Running</span>';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    indicator.className = 'status-indicator status-stopped';
                    indicator.innerHTML = '<span>üî¥</span><span>Agent Stopped</span>';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update metrics
        async function updateMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                if (data.success) {
                    // Overview metrics
                    document.getElementById('overview-metrics').innerHTML = `
                        <div class="metric">
                            <span class="metric-label">Total Spend</span>
                            <span class="metric-value">‚Çπ${data.total_spend.toFixed(0)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Revenue</span>
                            <span class="metric-value">‚Çπ${data.total_revenue.toFixed(0)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average ROAS</span>
                            <span class="metric-value">${data.avg_roas.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Profit</span>
                            <span class="metric-value">‚Çπ${(data.total_revenue - data.total_spend).toFixed(0)}</span>
                        </div>
                    `;
                    
                    // Ad set metrics
                    let adsetHtml = '';
                    data.metrics.forEach(metric => {
                        adsetHtml += `
                            <div class="metric">
                                <span class="metric-label">${metric.ad_set_name}</span>
                                <span class="metric-value">ROAS: ${metric.roas.toFixed(2)}</span>
                            </div>
                        `;
                    });
                    document.getElementById('adset-metrics').innerHTML = adsetHtml;
                } else {
                    document.getElementById('overview-metrics').innerHTML = '<div class="loading">Error loading metrics</div>';
                }
            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        // Update actions
        async function updateActions() {
            try {
                const response = await fetch('/api/actions');
                const data = await response.json();
                
                if (data.success && data.actions.length > 0) {
                    let actionsHtml = '';
                    data.actions.reverse().forEach(action => {
                        const actionClass = action.success ? 'action-success' : 'action-failed';
                        const actionIcon = action.success ? '‚úÖ' : '‚ùå';
                        
                        actionsHtml += `
                            <div class="action-item ${actionClass}">
                                <div>${actionIcon} <strong>${action.action_type.toUpperCase()}</strong>: ${action.ad_set_name}</div>
                                <div>${action.reason}</div>
                                <div class="action-time">${new Date(action.timestamp).toLocaleString()}</div>
                            </div>
                        `;
                    });
                    document.getElementById('recent-actions').innerHTML = actionsHtml;
                } else {
                    document.getElementById('recent-actions').innerHTML = '<div class="loading">No actions yet</div>';
                }
            } catch (error) {
                console.error('Error updating actions:', error);
            }
        }

        // Update chart
        async function updateChart() {
            try {
                const response = await fetch('/api/performance_chart');
                const data = await response.json();
                
                if (data.success) {
                    const traces = [];
                    
                    Object.keys(data.chart_data).forEach(adSetName => {
                        const adSetData = data.chart_data[adSetName];
                        
                        traces.push({
                            x: adSetData.timestamps,
                            y: adSetData.roas,
                            name: adSetName,
                            type: 'scatter',
                            mode: 'lines+markers'
                        });
                    });
                    
                    const layout = {
                        title: 'ROAS Performance Over Time',
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'ROAS' },
                        showlegend: true
                    };
                    
                    Plotly.newPlot('performance-chart', traces, layout);
                } else {
                    document.getElementById('performance-chart').innerHTML = '<div class="loading">No chart data available</div>';
                }
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }

        // Chat functionality
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            addChatMessage('filo', 'Thinking...', 'typing');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.success) {
                    addChatMessage('filo', data.response);
                } else {
                    addChatMessage('filo', '‚ùå Error: ' + data.error);
                }
            } catch (error) {
                removeTypingIndicator();
                addChatMessage('filo', '‚ùå Connection error: ' + error.message);
            }
        }
        
        function addChatMessage(sender, message, className = '') {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message ${className}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>üë§ You:</strong> ${message}`;
                messageDiv.style.textAlign = 'right';
                messageDiv.style.background = '#e6f3ff';
                messageDiv.style.marginLeft = '20%';
            } else {
                messageDiv.innerHTML = `<strong>ü§ñ Claude:</strong> ${message.replace(/\n/g, '<br>')}`;
                messageDiv.style.background = '#f0fff4';
                messageDiv.style.marginRight = '20%';
            }
            
            messageDiv.style.padding = '10px';
            messageDiv.style.margin = '10px 0';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.border = '1px solid #e2e8f0';
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Allow Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            
            // Auto-refresh every 30 seconds
            updateInterval = setInterval(updateDashboard, 30000);
        });
    </script>
</body>
</html>